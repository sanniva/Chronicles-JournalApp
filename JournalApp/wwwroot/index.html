<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Journal App</title>

    <!-- App CSS -->
    <link href="css/app.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous" />

    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Theme helper -->
    <script>
        window.themeHelper = {
            setDark: function (isDark) {
                if (isDark)
                    document.documentElement.classList.add('dark');
                else
                    document.documentElement.classList.remove('dark');

                localStorage.setItem('appTheme', isDark ? 'dark' : 'light');
            },
            getTheme: function () {
                return localStorage.getItem('appTheme') || 'light';
            }
        };
        
    </script>
</head>

<body>
<div id="app"></div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Quill Integration Script -->
<script>
    window.quillEditor = null;
    window.dotNetReference = null;

    window.initializeQuill = function (dotNetHelper, initialContent) {
        try {
            // Store the .NET reference
            window.dotNetReference = dotNetHelper;

            // Wait for the editor container to be available
            const editorContainer = document.getElementById('editor-container');
            if (!editorContainer) {
                console.error('Editor container not found');
                return false;
            }

            // Destroy existing instance if any
            if (window.quillEditor) {
                window.quillEditor = null;
                editorContainer.innerHTML = '';
            }

            // Initialize Quill
            window.quillEditor = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link', 'blockquote', 'code-block'],
                        [{ 'color': [] }, { 'background': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Write your thoughts here...'
            });

            // Set initial content if provided
            if (initialContent && initialContent.trim() !== '' && initialContent !== '<p><br></p>') {
                window.quillEditor.root.innerHTML = initialContent;
            }

            // Listen for text changes
            window.quillEditor.on('text-change', function () {
                const html = window.quillEditor.root.innerHTML;
                const text = window.quillEditor.getText();
                const charCount = text.trim().length;

                // Update character count display
                const charCountElement = document.getElementById('char-count');
                if (charCountElement) {
                    charCountElement.textContent = charCount;
                }

                // Notify Blazor component
                if (window.dotNetReference) {
                    window.dotNetReference.invokeMethodAsync('UpdateContent', html, charCount);
                }
            });

            console.log('Quill editor initialized successfully');
            return true;
        } catch (error) {
            console.error('Error initializing Quill:', error);
            return false;
        }
    };

    window.getQuillContent = function () {
        if (window.quillEditor) {
            return window.quillEditor.root.innerHTML;
        }
        return '';
    };

    window.setQuillContent = function (content) {
        if (window.quillEditor) {
            window.quillEditor.root.innerHTML = content || '';
            return true;
        }
        return false;
    };

    window.destroyQuill = function () {
        if (window.quillEditor) {
            window.quillEditor = null;
        }
        if (window.dotNetReference) {
            window.dotNetReference = null;
        }
    };
</script>

<!-- Blazor MAUI bootstrap -->
<script src="_framework/blazor.webview.js"></script>
</body>
</html>